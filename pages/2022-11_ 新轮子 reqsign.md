title:: 2022-11: 新轮子 reqsign
type:: [[Blog]]

- 这周主要的时间都在搓新轮子 [reqsign](https://github.com/Xuanwo/reqsign)，用于对用户的请求进行签名，使得用户不再需要依赖完整的 SDK，我将其概括为 `Signing API requests without effort`。今天这期周报就主要聊聊为什么要造这个轮子，以及适合使用它的场景。
-
- 背景
	- 开发云上服务不可避免的会使用 SDK，它帮助用户处理认证，构造请求，解析响应等任务，使得用户不需要关心服务内部的细节。对于绝大多数用户来说，使用 SDK 已经足够满足需求，但是 SDK 也有不小的弊端。
	- 首先，不同服务的 SDK 维护质量参差不齐。大多数 SDK 都无法及时响应来自用户的需求，没有定期的漏洞补丁和安全审查。对小众语言来说这个问题尤为严重，以 Rust 为例，对象存储服务中提供官方 SDK 支持的只有 AWS S3，其他的服务都只有社区维护的 SDK。
	- 其次，跨 SDK 的行为很难统一。云上服务不可避免的会出现偶尔的内部错误和超时，所以很多 SDK 都包装了自己的重试和超时逻辑。应用如果想设置统一的重试和超时行为，就需要逐个服务的去研究如何进行配置。底层的数据库服务还会需要控制 SDK 内部的 Client ，控制并发， 限流限速，控制内存占用等，这就更难以实现了。
	- 最后，代码生成的 SDK 复杂而难用。为了降低 SDK 的维护成本，很多服务使用代码生成的方式来构建 SDK。为了统一内部不同服务的接口，往往需要增加无数层抽象，把简单的 HTTP API 变成了一大堆复杂的中间件。以 AWS 的 Rust SDK 为例，为了使用 `aws-sdk-s3`，我们需要依赖 `aws-endpoint`，`aws-http`，`aws-sig-auth`，`aws-sigv4` ，`aws-config` 等一大包 crate。这个问题在业务只需要使用 SDK 中特定几个方法的时候变得尤为严重，为了发送一个 `get_object` 请求，应用的构建时间增加了 120 秒，二进制提及变大了 6MB。更糟糕的是，为了支持从 AWS STS 服务获取临时的 token，`aws-config` 还依赖了 `aws-sdk-sts` 和 `aws-sdk-sso`，在  `aws-sdk-sts` 中同样需要走一遍完整的流程。
- 反思
	- 于是我开始思考，为什么简单的 HTTP API 变成了如今这样？核心逻辑明明只有 `HTTP 1.1 GET https://127.0.0.1/abc` ，我们为什么需要做这么多额外的工作？如果自己来构造这个请求会不会变得更简单？
	- 一个星期之前，我在 [opendal](https://github.com/datafuselabs/opendal) 的讨论区记录下了这个想法：[Self maintianed SDK](https://github.com/datafuselabs/opendal/discussions/139)。但是我很快意识到，这样的做法是不可维护的：在项目中为用到的每一个服务维护独立的 SDK 在未来会变成一个沉重的负担。更糟糕的是，我在重复造轮子，所有现有的 SDK 踩过的坑，实现的细节我需要在项目中重新趟一遍。不仅如此，其他的开源项目无法复用我的工作成果，使得这个做法的收益比极低。
	- 紧接着，我开始思考为什么维护 SDK 的成本会这么高。
-